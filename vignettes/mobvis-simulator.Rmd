---
title: "Visualizing simulator data"
author: "Martijn Tennekes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Visualizing simulator data}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    fig.width=6, 
    fig.height=4,
    comment = "#>"
)
```


```{r}
library(mobvis)
library(tmap)
tmap_options(show.warnings = FALSE)
```

The simulator software is a framework to run mobile network data micro-simulations [1]

## Example data from the simulator

Example data for the simulator, both the input and the output files, are contained in this package as a single zip file. It can be retrieved and extracted as follows.

```{r}
# specify folder for the simulator files
dir <- "simdata"
if (!dir.exists(dir)) dir.create(dir, recursive = TRUE) else unlink(dir, recursive = TRUE)

# unzip the zip file into that folder 
zipfile <- system.file("sim", "simdata.zip", package = "mobvis")
unzip(zipfile, exdir = dir)
```

In this case, the files will be located in the `"simdata"` subfolder of the working directory. The input files are stored in that folder, and the output files in the subfolder `"simdata/output"`.

In order to use this simulator data in **mobvis**, we have to create a list object that contains a few settings.

```{r}
sim <- list(input_dir = "simdata",
            output_dir = "simdata/output",
            mno = "MNO1",
            crs = st_crs(NA))
```

Besides the input and output directories, it also contains the MNO name, in this case `"MNO1"`, and a CRS (coordinate reference system). The latter is needed


it also contains a crs (coordinate reference system), which is needed to create interactive maps.
Since this data is fictional, the crs is centered on Boa Vista, a small island in the Atlantic Ocean.


## Signal strength

```{r, fig.show="hold", out.width="80%"}
rst <- sim_get_raster(sim)
cp <- sim_get_cellplan(sim)
region <- sim_get_region(sim)
strength <- sim_get_signal_strength(sim, rst, cp)

map_sig_strength(rst, 
                 dt = strength, 
                 cp = cp, 
                 region = region, 
                 cells = 3, 
                 type = "dBm", 
                 interactive = FALSE, 
                 settings = mobvis_settings_static(cell_size = 1,
                                                   cell_labels = TRUE))
map_sig_strength(rst, 
                 dt = strength, 
                 cp = cp, 
                 region = region, 
                 cells = 3, 
                 type = "s", 
                 interactive = FALSE, 
                 settings = mobvis_settings_static(cell_colors = "gold", 
                                                   cell_size = 1, 
                                                   cell_labels = TRUE, 
                                                   cell_label_color = "white"))
map_best_server(rst = rst,
                dt = strength,
                cp = cp,
                region = region,
                cells = 3,
                type = "bsm",
                interactive = FALSE,
                settings = mobvis_settings_static(cell_colors = "black", 
                                                  cell_size = 1, 
                                                  cell_labels = TRUE, 
                                                  cell_label_color = "black"))
```


## Event location

The following function visualizes the event location.

```{r}
# Calculate the event location (likelihood) probabilities using mobloc
library(mobloc)
param <- mobloc_param()
strength[, dist:= NA]
strength_llh <- create_strength_llh(strength, param = param)

# Edit the visualization settings
settings = mobvis_settings_static(cell_size = 2, dev_size = 2)
settings$titles["pag"] <- "Event location"

# Create the plot
map_pag(rst, 
        dt = strength_llh, 
        cp = cp, 
        region = region, 
        cells = 3, 
        interactive = FALSE, 
        settings = settings)
```


## Posterior probabilities

```{r}
network_prior <- create_network_prior(strength, rst)
posterior <- calculate_posterior(prior = network_prior, llh = strength_llh, raster = rst)

# Edit settings
settings$titles["pga"] <- "Posterior probabilities"

# Create the plot
map_pga(rst, 
        dt = posterior, 
        cp = cp, 
        region = region, 
        cells = 3, 
        interactive = FALSE, 
        settings = settings)

```


## Trajectories

The simulator simulates trajectories of devices. The following code retrieves the routes and calculates the traveled distance per device.


```{r}
# get route and distance per device
routes <- sim_get_trajectory_routes(sim)
print(routes)

# plot the routes with tmap (run tmap_mode("view") to show it interactively)
qtm(region) + qtm(routes)
```

Interactive exploratin of this map allows us to focus on particular devices that are interesting for further analysis. For instance, the route of device 250 is interesting, since it moved at a steady pace and direction in an area with a high density of cells, including one atenna that contains three directional cells.


```{r}
traj <- sim_get_trajectory_data(sim, device = 250)

maps_event_loc <- lapply(1:nrow(traj), function(i) {
    ti = traj[i,]
    llhi = strength_llh[cell==ti$cell, ]
    map_pag(rst, 
            dt = llhi, 
            cp = cp, 
            region = region, 
            cells = ti$cell, 
            dev = ti,
            interactive = FALSE, 
            settings = settings)
})

tmap_animation(maps_event_loc, filename = "event_locations_dev_250.mp4", width = 700, height = 700, fps = 3)
```

```{r}
maps_post = lapply(1:nrow(traj), function(i) {
    ti = traj[i,]
    posti = posterior[cell==ti$cell, ]
    map_pga(rst, 
            dt = posti, 
            cp = cp, 
            region = region, 
            cells = ti$cell, 
            dev = ti,
            interactive = FALSE, 
            settings = settings)
})

tmap_animation(maps_post, filename = "posterior_dev_250.mp4", width = 700, height = 700, fps = 3)
```







## References

1. To do: add reference simulator documentation 

